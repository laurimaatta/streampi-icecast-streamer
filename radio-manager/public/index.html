<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>StreamPi</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="loginOverlay" class="login-overlay" hidden>
    <div class="login-wrap">
      <div class="login-card card">
        <div class="login-header">
          <h1 class="login-title">StreamPi</h1>
          <p class="login-subtitle muted">Kirjaudu hallintapaneeliin</p>
        </div>
        <form id="formLogin" class="form-grid login-form">
          <label>
            <span class="label-text">Käyttäjätunnus</span>
            <input type="text" name="username" placeholder="Käyttäjätunnus" autocomplete="username">
          </label>
          <label>
            <span class="label-text">Salasana</span>
            <input type="password" name="password" placeholder="••••••••" autocomplete="current-password">
          </label>
          <p id="loginError" class="login-error" style="display:none;"></p>
          <div class="login-actions">
            <button type="submit">Kirjaudu</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div id="appContent">
  <header class="header">
    <h1>StreamPi</h1>
    <div class="header-right">
      <div class="status-pill" id="streamStatus" aria-live="polite">—</div>
      <div class="status-pill" id="muteStatus" aria-live="polite">—</div>
      <button type="button" id="btnLogout" class="btn-logout" title="Kirjaudu ulos">Kirjaudu ulos</button>
    </div>
  </header>

  <nav class="tabs" role="tablist">
    <button type="button" class="tab active" role="tab" id="tab-streaming" aria-selected="true" aria-controls="panel-streaming">Lähetys</button>
    <button type="button" class="tab" role="tab" id="tab-audio" aria-selected="false" aria-controls="panel-audio">Ääni</button>
    <button type="button" class="tab" role="tab" id="tab-system" aria-selected="false" aria-controls="panel-system">Järjestelmä</button>
  </nav>

  <main>
    <section id="panel-streaming" class="panel active" role="tabpanel" aria-labelledby="tab-streaming">
      <div class="card">
        <h2>Lähetyksen ohjaus</h2>

        <!-- Ei kytkintä: Käynnistä / Lopeta -nappi -->
        <div id="streamNoSwitchPanel">
          <div class="btn-group">
            <button type="button" id="btnToggleStream">Käynnistä</button>
            <button type="button" id="btnRestart" style="display:none;">Käynnistä uudelleen</button>
          </div>
        </div>

        <!-- Kytkin käytössä: pelkkä tila -->
        <div id="streamSwitchPanel" hidden>
          <p id="streamStateLabelSwitch" class="mute-state-label" aria-live="polite">Pysäytetty – kytkin</p>
          <p class="muted small">Tila ohjataan kytkimellä.</p>
          <div class="btn-group" style="margin-top:0.75rem;">
            <button type="button" id="btnRestartWhenSwitch" style="display:none;">Käynnistä uudelleen</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h2>Vaimennus</h2>

        <!-- Ei kytkintä: yksinkertainen web-nappi -->
        <div id="muteNoSwitchPanel">
          <div class="btn-group">
            <button type="button" id="btnMuteToggle">Vaimenna</button>
          </div>
          <p id="muteStateLabel" class="mute-state-label" aria-live="polite">Ääni päällä</p>
        </div>

        <!-- Kytkin käytössä: pelkkä tila -->
        <div id="muteSwitchPanel" hidden>
          <p id="muteStateLabelSwitch" class="mute-state-label" aria-live="polite">Ääni päällä – kytkin</p>
          <p class="muted small">Tila ohjataan kytkimellä.</p>
        </div>
      </div>
      <div class="card">
        <h2>Lähetyksen asetukset</h2>
        <p class="muted">Tallenna muutokset ja käynnistä lähetys uudelleen tarvittaessa.</p>
        <p id="envNote" class="muted small" style="display:none;">Jotkut asetukset on määritetty järjestelmän puolella.</p>
        <form id="formDarkice" class="form-grid">
          <label>Palvelin <input type="text" name="server" placeholder="icecast.example.com"></label>
          <label>Portti <input type="number" name="port" min="1" max="65535" placeholder="8000"></label>
          <label>Mount-piste <input type="text" name="mountPoint" placeholder="live.mp3"></label>
          <label>Salasana <input type="password" name="password" placeholder="••••••••"></label>
          <label>Lähetyksen nimi <input type="text" name="name" placeholder="Oma lähetys"></label>
          <label>Bittinopeus (kbps) <input type="number" name="bitrate" min="32" max="320" placeholder="128"></label>
          <label>Näytteenottotaajuus <select name="sampleRate">
            <option value="44100">44100 Hz</option>
            <option value="48000">48000 Hz</option>
            <option value="22050">22050 Hz</option>
            <option value="16000">16000 Hz</option>
          </select></label>
          <label>Kanavat <select name="channel">
            <option value="1">Mono (1 kanava) – suositeltu puheelle</option>
            <option value="2">Stereo (2 kanavaa)</option>
          </select></label>
          <div id="deviceRow"><label>Äänilähde <select name="device"></select></label></div>
          <div class="form-actions">
            <button type="submit">Tallenna asetukset</button>
            <button type="button" id="btnRestartAfterSave">Tallenna ja käynnistä lähetys uudelleen</button>
          </div>
        </form>
      </div>
    </section>

    <section id="panel-audio" class="panel" role="tabpanel" aria-labelledby="tab-audio" hidden>
      <div class="card">
        <h2>Äänen säätö</h2>
        <p class="muted">Voimakkuudet ja tasot. Muutokset tulevat voimaan heti. Tallenna tila, jotta asetukset säilyvät laitteen uudelleenkäynnistyksen jälkeen.</p>
        <p id="muteDisabledHint" class="muted small" style="display:none;">Hiljennystila päällä: äänenvoimakkuuden säätö on pois käytöstä. Avaa vaimennuskytkin tai valitse vaimennus "Pois" lähetys-välilehdeltä.</p>
        <p id="alsaStateIndicator" class="muted small" aria-live="polite">—</p>
        <div class="alsa-groups">
          <div class="alsa-group" id="alsaGroupCapture">
            <h3>Lähetykseen menevä ääni (sisääntulo)</h3>
            <div id="audioControlsCapture" class="audio-controls-grid"></div>
          </div>
          <div class="alsa-group alsa-group-combined" id="alsaGroupPlaybackAndALC">
            <h3>Äänenlaatu ja automaattinen voimakkuuden säätö</h3>
            <p class="muted small">Kuuntelu- ja ulosmenotasot sekä voimakkuuden tasaus (puhe, laulu).</p>
            <div id="audioControlsPlayback" class="audio-controls-grid"></div>
            <div id="audioControlsALC" class="audio-controls-grid"></div>
          </div>
        </div>
        <div class="btn-group" id="audioButtonGroup">
          <button type="button" id="btnApplyAlsaDefaults" title="Asettaa suositellut tasot puhe-/lähetyskäyttöön. Tallenna tila alta, jotta asetukset säilyvät.">Palauta suositellut ääniasetukset</button>
          <button type="button" id="btnStoreAlsa" title="Tallentaa nykyiset volyymit ja tasot. Ne otetaan käyttöön seuraavalla käynnistyksellä.">Tallenna äänitila</button>
          <button type="button" id="btnRestoreAlsa" title="Palauttaa aiemmin tallennetut volyymit ja tasot.">Palauta tallennettu äänitila</button>
        </div>
      </div>
    </section>

    <section id="panel-system" class="panel" role="tabpanel" aria-labelledby="tab-system" hidden>
      <div class="card">
        <h2>Laiteasetukset</h2>
        <div class="toggle-row">
          <label class="toggle-label">
            <input type="checkbox" id="chkStreamSwitch">
            <span>Lähetyskytkin käytössä</span>
          </label>
          <p class="muted small">Kun käytössä: lähetys ohjataan vain kytkimellä. Kun pois: lähetys ohjataan Lähetys-välilehden napilla. Uudelleenkäynnistys onnistuu käyttöliittymästä molemmissa tiloissa.</p>
        </div>
        <div class="toggle-row" style="margin-top:1rem;">
          <label class="toggle-label">
            <input type="checkbox" id="chkMuteSwitch">
            <span>Vaimennuskytkin käytössä</span>
          </label>
          <p class="muted small">Kun käytössä: vaimennus ohjataan kytkimellä. Kun pois: vaimennus ohjataan Lähetys-välilehden napilla – tila nollautuu käynnistyksen yhteydessä.</p>
        </div>
      </div>
      <div class="card">
        <h2>Web-kirjautuminen</h2>
        <p class="muted small">Käyttäjätunnus on aina <strong>admin</strong>. Oletussalasana <strong>streamPi</strong> – vaihda heti omaan.</p>
        <form id="formAuth" class="form-grid">
          <label>Nykyinen salasana <input type="password" name="authCurrentPassword" placeholder="••••••••" autocomplete="current-password"></label>
          <label>Uusi salasana <input type="password" name="authNewPassword" placeholder="••••••••" autocomplete="new-password"></label>
          <label>Uusi salasana uudestaan <input type="password" name="authNewPasswordConfirm" placeholder="••••••••" autocomplete="new-password"></label>
          <div class="form-actions">
            <button type="submit">Vaihda kirjautumistiedot</button>
            <button type="button" id="btnAuthRemove">Poista kirjautuminen</button>
          </div>
        </form>
      </div>
      <div class="card">
        <h2>Varmuuskopio ja palautus</h2>
        <div class="backup-actions">
          <button type="button" id="btnExport">Lataa varmuuskopio (JSON)</button>
          <label class="file-label"><input type="file" id="importFile" accept=".json"> Tuo tiedostosta</label>
        </div>
        <hr>
        <h3>Paikalliset varmuuskopiot</h3>
        <button type="button" id="btnSaveLocal">Luo varmuuskopio nyt</button>
        <ul id="localBackupList" class="backup-list"></ul>
        <div id="restoreRow" class="restore-row" style="display:none">
          <label>Palauta: <select id="restoreSelect"></select></label>
          <button type="button" id="btnRestoreLocal">Palauta</button>
        </div>
      </div>
    </section>
  </main>

  <div id="httpsHint" class="https-hint muted small">
    Jos selain varoittaa yhteydestä, voit hyväksyä poikkeuksen ja jatkaa turvallisesti.
  </div>
  <div id="toast" class="toast" aria-live="polite"></div>
  </div>
  <script src="app.js"></script>
</body>
</html>
